<html>
<head>
	<title>Townforge | Map</title>
	<link rel="stylesheet" href="./dist/leaflet.css"/>
<!-- Make sure you put this AFTER Leaflet's CSS -->
	<script src="./dist/leaflet.js"></script>

<!-- https://github.com/ablakey/Leaflet.SimpleGraticule --> 
	<link rel="stylesheet" href="./dist/L.SimpleGraticule.css" />
	<script src="./dist/L.SimpleGraticule.js"></script>
<!-- https://github.com/ablakey/Leaflet.SimpleGraticule --> 

<!-- https://github.com/BenPortner/leaflet-burgermenu --> 
	<link rel="stylesheet" href="./dist/leaflet-burgermenu.css"/>
	<script src="./dist/leaflet-burgermenu.umd.min.js"></script>
<!-- https://github.com/BenPortner/leaflet-burgermenu -->

<!-- Autocomplete on forms --> 
	<link rel="stylesheet" href="./dist/my-autocomplete.css"/>
	<script src="./dist/my-autocomplete.js"></script>
<!-- Autocomplete on forms --> 
<style>
#map {
	height: 100%;
	width:  100%;
	background: none;
	}
.popup_table {
	white-space: nowrap;
	}
/*<!-- .popup_without_tip .leaflet-popup-tip   first value add/edit second already defined value--> */
.popup_without_tip .leaflet-popup-tip {
	display: none;
	}
.leaflet-popup-content {
	width:auto !important;
	}
/*<!-- info box top right--> */
.info { padding: 6px 8px; font: 14px/16px Arial, Helvetica, sans-serif; background: white; background: rgba(255,255,255,0.8); box-shadow: 0 0 15px rgba(0,0,0,0.2); border-radius: 5px; } 
.info h4 { margin: 0 0 5px; color: #777; }
/*<!-- info box top right-->*/
.Legend_text_background_repair {
	line-height: 22px;
	width: 45px;
	border-radius: 15%;
	white-space: nowrap;
	text-align: center;
	}
.Legend_text_background_role {
	line-height: 22px;
	width: 115px;
	border-radius: 15%;
	white-space: nowrap;
	text-align: center;
	}
.Legend_text_background_Economic_Power {
	line-height: 22px;
	width: 55px;
	border-radius: 15%;
	white-space: nowrap;
	text-align: center;
	}
.Legend_br_height {
	line-height: 0.2;
	}
/*<!-- Flag sizes -->*/
.Flag_size {
	font-size: 10px; /* also inside function*/
	font-weight: 1;
	color: black;
	}
.Flag_size_x {
	writing-mode: horizontal-tb;
	}
.Flag_size_y {
	writing-mode: vertical-rl;
	}
/*<!-- Flag sizes -->*/
/*<!-- Pulsing Marker -->*/
.css-icon {
	}
.gps_ring {
	border: 3px solid #999;
	-webkit-border-radius: 30px;
	height: 18px;
	width: 18px;
	-webkit-animation: pulsate 1s ease-out;
	-webkit-animation-iteration-count: infinite; 
	/*opacity: 0.0*/
	}
@-webkit-keyframes pulsate {
	0% {-webkit-transform: scale(0.1, 0.1); opacity: 0.0;}
	50% {opacity: 1.0;}
	100% {-webkit-transform: scale(1.2, 1.2); opacity: 0.0;}
	}
/*<!-- Pulsing Marker -->*/
#HomeButton{
	display: flex;
	align-items: center;
	position: absolute;
	bottom: 27px;
	left: 45px;
	width: 32px;
	height: 32px;
	background-color: white;
	border-radius: 5px;
	border-color: gray;
	border-style: solid;
	border-width: 1px 1px 1px 1px;
	opacity: 0.8;
	text-align: center;
	z-index: 1000;
	justify-content: center;
	align-items: center;
	}
#HomeButton:hover{
	opacity: 1;
	cursor: pointer;
	}
#Calculate_influence_button{
	display: flex;
	align-items: center;
	position: absolute;
	bottom: 27px;
	left: 80px;
	width: 70px;
	height: 32px;
	background-color: white;
	border-radius: 5px;
	border-color: gray;
	border-style: solid;
	border-width: 1px;
	opacity: 0.8;
	text-align: center;
	z-index: 1000;
	justify-content: center;
	align-items: center;
	}
#Calculate_influence_button:hover{
	opacity: 1;
	cursor: pointer;
	}
#Disable_Highlight_Button{
	display: none;
	align-items: center;
	position: absolute;
	top: 5%;
	left: 50%;
	width: 200px;
	height: 50px;
	background-color: Lime;
	border-radius: 5px;
	border-color: Green;
	border-style: solid;
	border-width: 2px;
	opacity: 0.8;
	text-align: center;
	z-index: 1000;
	justify-content: center;
	align-items: center;
	}
#Disable_Highlight_Button:hover{
	opacity: 1;
	cursor: pointer;
	}
tr:nth-child(even) {
	/*Use an rgba() color to specify the transparency of the color:*/
	background-color: rgba(117, 117, 117, 0.1);
	}
</style>
</head>

<body>
<div id="map">
	<button id="HomeButton" title='Reset Map View' onclick='map.setView( [0, 0], -1);'>
		<img src="./dist/home.svg" style="width:20px;"></img>
		</button>
	<button id="Calculate_influence_button" title='Calculate Influence of Flags on Selection' style="line-height: 1;"
		onclick='
			if (map.hasLayer(featureGroup_Legend) == false) {
				document.getElementById("Calculate_influence_button").style.background="Lime";
				document.getElementById("Calculate_influence_button").style.border="2px solid Green";
				featureGroup_Legend.addTo(map).clearLayers();
				legend_Influence_calculator.addTo(map);
				legend_role.remove();
				legend_repair.remove();
				legend_owner.remove();
				legend_EcoPow.remove();
				}
			else if (map.hasLayer(featureGroup_Legend) == true) {
				document.getElementById("Calculate_influence_button").style.background="White";
				document.getElementById("Calculate_influence_button").style.border="1px solid Gray";
				featureGroup_Legend.remove();
				legend_Influence_calculator.remove();
				if (map.hasLayer(LayerStyle_Role) == true) {legend_role.addTo(map)};
				if (map.hasLayer(LayerStyle_Repair) == true) {legend_repair.addTo(map)};
				if (map.hasLayer(LayerStyle_Owner) == true) {legend_owner.addTo(map)};
				if (map.hasLayer(LayerStyle_EconomicPower) == true) {legend_EcoPow.addTo(map)};
				}
			'>
		Influence Calculator 
		</button>
	<button id="Disable_Highlight_Button" title='Disable Highlighted Flags' onclick='Show_only_account_id = 0;resetStyleOfAll_Layer1_Flags_City();document.getElementById("Disable_Highlight_Button").style.display = "none";'>
		Disable Highlighting Flags
		</button>
	</div>
<script type="text/javascript" src="GeoJSON_Flags_data.js"></script>
<script type="text/javascript" src="Arrays_AccountCity_data.js"></script>
<script>
function generateAll_Flags_city() {
	globalThis.All_Flags_city = []
	let CityNumber = 0
	while (true) {
		if (eval('typeof Flags_city' + CityNumber) !== "undefined") {
			All_Flags_city[CityNumber] = eval('Flags_city' + CityNumber)
			CityNumber += 1
			}
		else {
			break;
			}
		}
	}

function generateArray_Autocomplete_AccountHouse() {
	globalThis.Autocomplete_AccountHouse = []
	Autocomplete_AccountHouse.push("");
	for (let i = 1; i < Account_data.length; i++) {
		Autocomplete_AccountHouse.push(Account_data[i][0]);
		}
	return null;
	}

function generateArray_Autocomplete_AccountName() {
	globalThis.Autocomplete_AccountName = []
	Autocomplete_AccountName.push("");
	for (let i = 1; i < Account_data.length; i++) {
		Autocomplete_AccountName.push(Account_data[i][1]);
		}
	return null;
	}

function generateArray_Autocomplete_FlagId() {
	const allFeatures = All_Flags_city.flatMap(flag => flag.features);
	globalThis.Autocomplete_FlagId = allFeatures.map(feature => feature.id.toString());
	return null;
	}

function generateArray_Autocomplete_FlagName() {
	const allFeatures = All_Flags_city.flatMap(flag => flag.features);
	globalThis.Autocomplete_FlagName = allFeatures.map(feature => feature.properties.name.toString());
	return null;
	}

function declareLayer0_City() {
	City_data.forEach((value, index) => {
		eval('globalThis.Layer0_City' + index + ' = L.geoJson([])') 
		if (index == 0) {
			eval('Layer0_City' + index).addTo(map)
			}
		});
	}

function declareLayer0_City0_events() {
	City_data.forEach((value, index) => {
		eval('Layer0_City' + index).on("add",(e)=>{eval('Layer1_Firefighting_City' + index).addTo(Layer0_Overlay_Firefighting);})
		eval('Layer0_City' + index).on("add",(e)=>{eval('Layer1_TaxBreakPoints_City' + index).addTo(Layer0_Overlay_TaxBreakPoints);})
		eval('Layer0_City' + index).on("add",(e)=>{eval('Layer1_Image_RoleFlags_City' + index).addTo(Layer0_Overlay_RoleImages);})
		eval('Layer0_City' + index).on("add",(e)=>{eval('Layer1_TextFlagSize_City' + index).addTo(Layer0_Overlay_TextFlagSize);})
		eval('Layer0_City' + index).on("add",(e)=>{eval('Layer0_City' + index).bringToBack();})

		eval('Layer0_City' + index).on("remove",(e)=>{eval('Layer1_Firefighting_City' + index).removeFrom(Layer0_Overlay_Firefighting);})
		eval('Layer0_City' + index).on("remove",(e)=>{eval('Layer1_TaxBreakPoints_City' + index).removeFrom(Layer0_Overlay_TaxBreakPoints);})
		eval('Layer0_City' + index).on("remove",(e)=>{eval('Layer1_Image_RoleFlags_City' + index).removeFrom(Layer0_Overlay_RoleImages);})
		eval('Layer0_City' + index).on("remove",(e)=>{eval('Layer1_TextFlagSize_City' + index).removeFrom(Layer0_Overlay_TextFlagSize);})
		eval('Layer0_City' + index).on("remove",(e)=>{map.removeLayer(SearchMarker);})
		});
	}

function declareLayer0_Overlays() {
	globalThis.Layer0_Overlay_Firefighting = L.featureGroup([]);
	globalThis.Layer0_Overlay_TaxBreakPoints = L.featureGroup([]);
	globalThis.Layer0_Overlay_RoleImages = L.featureGroup([]).addTo(map);
	globalThis.Layer0_Overlay_InfluenceMouseOver = L.featureGroup([]);
	globalThis.Layer0_Overlay_TextFlagSize = L.featureGroup([]);
	}

function declareLayerStyle_Role() {
	globalThis.LayerStyle_Role = L.featureGroup([]).addTo(map)
	LayerStyle_Role.on('add',(e)=>{if (map.hasLayer(featureGroup_Legend) == false) {legend_role.addTo(map)};})
	LayerStyle_Role.on('remove',(e)=>{legend_role.remove();})
	City_data.forEach((value, index) => {
		LayerStyle_Role.on("add",(e)=>{resetStyleOfAll_Layer1_Flags_City()})
		});
	}

function declareLayerStyle_Repair() {
	globalThis.LayerStyle_Repair = L.featureGroup([])
	LayerStyle_Repair.on('add',(e)=>{if (map.hasLayer(featureGroup_Legend) == false) {legend_repair.addTo(map)};})
	LayerStyle_Repair.on('remove',(e)=>{legend_repair.remove();})
	City_data.forEach((value, index) => {
		LayerStyle_Repair.on("add",(e)=>{resetStyleOfAll_Layer1_Flags_City()})
		});
	}

function declareLayerStyle_Owner() {
	globalThis.LayerStyle_Owner = L.featureGroup([])
	LayerStyle_Owner.on('add',(e)=>{if (map.hasLayer(featureGroup_Legend) == false) {legend_owner.addTo(map)};})
	LayerStyle_Owner.on('remove',(e)=>{legend_owner.remove();})
	City_data.forEach((value, index) => {
		LayerStyle_Owner.on("add",(e)=>{resetStyleOfAll_Layer1_Flags_City()})
		});
	}

function declareLayerStyle_EconomicPower() {
	globalThis.LayerStyle_EconomicPower = L.featureGroup([])
	LayerStyle_EconomicPower.on('add',(e)=>{if (map.hasLayer(featureGroup_Legend) == false) {legend_EcoPow.addTo(map)};})
	LayerStyle_EconomicPower.on('remove',(e)=>{legend_EcoPow.remove();})
	City_data.forEach((value, index) => {
		LayerStyle_EconomicPower.on("add",(e)=>{resetStyleOfAll_Layer1_Flags_City()})
		});
	}

function declareLayer1_Image_InactiveFlags_City() {
	City_data.forEach((value, index) => {
		eval('globalThis.Layer1_Image_InactiveFlags_City' + index + ' = L.featureGroup([])') 
		eval('Layer1_Image_InactiveFlags_City' + index).addTo(eval('Layer0_City' + index))
		});
	}
	
function declareLayer1_Image_RoleFlags_City() {
	City_data.forEach((value, index) => {
		eval('globalThis.Layer1_Image_RoleFlags_City' + index + ' = L.featureGroup([])') 
		});
	}
	
function declareLayer1_TextFlagSize_City() {
	City_data.forEach((value, index) => {
		eval('globalThis.Layer1_TextFlagSize_City' + index + ' = L.featureGroup([])') 
		});
	}

function declareLayer1_Flags_City() {
	City_data.forEach((value, index) => {
		eval('globalThis.Layer1_Flags_City' + index + ' = L.geoJson(Flags_city' + index + ',{style:Style_Flags,onEachFeature})')
		eval('Layer1_Flags_City' + index).addTo(eval('Layer0_City' + index))
		});
		
	}

function declareLayer1_Firefighting_City() {
	City_data.forEach((value, index) => {
		eval('globalThis.' + 'Layer1_Firefighting_City' + index + ' = L.layerGroup([])')
		if (index == 0) {
			eval('Layer1_Firefighting_City' + index).addTo(Layer0_Overlay_Firefighting)
			}
		});
	}

function declareLayer1_TaxBreakPoints_City() {
	City_data.forEach((value, index) => {
		eval('globalThis.' + 'Layer1_TaxBreakPoints_City' + index + ' = L.layerGroup([])')
		if (index == 0) {
			eval('Layer1_TaxBreakPoints_City' + index).addTo(Layer0_Overlay_TaxBreakPoints)
			}
		});
	}

function declareLegend() {
	globalThis.featureGroup_Legend = L.featureGroup([]);
	}

function generate_RoleImg_InactiveImg_FlagSizeText_MilitaryFirefightingLayer() {
	All_Flags_city.forEach(
		Flags_cityN => {
			Flags_cityN.features.forEach(
				feature => {
					createRoleImagesOnFlags(feature)
					createInactiveImagesOnFlags(feature)
					createFlagSizesText(feature)
					createMilitaryFirefightingLayer(feature)
					}
				)
			}
		)
	}

function createRoleImagesOnFlags(feature) {
	if ( feature.properties.active == true && Img_role[feature.properties.role] != 0 ) {
		L.imageOverlay(Img_role[feature.properties.role], [xy(feature.geometry.coordinates[0][0]),xy(feature.geometry.coordinates[0][2])]).addTo(eval('Layer1_Image_RoleFlags_City' + feature.properties.city))
		}
	}

function createInactiveImagesOnFlags(feature) {
	if ( feature.properties.active == false && feature.properties.role != 0 ) {
		L.imageOverlay(Img_role[0], [xy(feature.geometry.coordinates[0][0]),xy(feature.geometry.coordinates[0][2])]).addTo(eval('Layer1_Image_InactiveFlags_City' + feature.properties.city))
		}
	}
	
function generateTaxBreakPoints() {
	City_data.forEach((value, index) => {
		City_data[index][8].forEach((value) => {
			L.marker(xy([value[0], value[1]])).addTo(eval('Layer1_TaxBreakPoints_City'+ index))
			L.marker(xy([value[0], value[1]]), {icon: cssIcon}).addTo(eval('Layer1_TaxBreakPoints_City' + index))
			});
		});
	}

function createFlagSizesText(feature) {
	const x_size = (feature.geometry.coordinates[0][2][0] - feature.geometry.coordinates[0][0][0] + 1)
	const y_size = (feature.geometry.coordinates[0][2][1] - feature.geometry.coordinates[0][0][1] + 1)
	const horizontal_position 	=	xy([	(feature.geometry.coordinates[0][0][0] + (x_size / 2)),	(feature.geometry.coordinates[0][0][1] + (y_size / 5))	])
	const vertical_position		=	xy([	(feature.geometry.coordinates[0][0][0] + (x_size / 5)),	(feature.geometry.coordinates[0][0][1] + (y_size / 2))	])
	L.marker(horizontal_position,	{icon: L.divIcon({className: 'Flag_size_x Flag_size',html: x_size}),zIndexOffset: 1000, interactive: false}).addTo(eval('Layer1_TextFlagSize_City' + feature.properties.city))
	L.marker(vertical_position,		{icon: L.divIcon({className: 'Flag_size_y Flag_size',html: y_size}),zIndexOffset: 1000, interactive: false}).addTo(eval('Layer1_TextFlagSize_City' + feature.properties.city))
	}

function createMilitaryFirefightingLayer(feature) {
	if ( feature.properties.active == true && feature.properties.role == 8 ) {
		const firefighting_influence = ( feature.properties.inf  * 350 / 100 )
		const x0=( feature.geometry.coordinates[0][0][0] - firefighting_influence )
		const x1=( feature.geometry.coordinates[0][2][0] + firefighting_influence )
		const y0=( feature.geometry.coordinates[0][0][1] - firefighting_influence )
		const y1=( feature.geometry.coordinates[0][2][1] + firefighting_influence )
		const Firefighting_Rectangle = L.rectangle([xy([x0, y0]),xy([x1, y1])], {color: 'DarkSlateGray',fillColor: 'LightGreen', weight: 3, fillOpacity: 0.5, interactive: false})
		Firefighting_Rectangle.addTo(eval('Layer1_Firefighting_City' + feature.properties.city ))
		}
	}

// POKUD AUTOCOMPLETE FUNKCI DAM PRIMO DO BUTTON ONCLICK PAK TO TAM NEFUNGUJE MUSIM TO MIT TAKHLE
function runAutocomplete_flag_id() {
	autocomplete(document.getElementById("myInput1"), Autocomplete_FlagId);
	}

function runAutocomplete_flag_names() {
	autocomplete(document.getElementById("myInput2"), Autocomplete_FlagName);
	}

function runAutocomplete_account_names() {
	autocomplete(document.getElementById("myInput3"), Autocomplete_AccountName);
	}

function runAutocomplete_house_names() {
	autocomplete(document.getElementById("myInput4"), Autocomplete_AccountHouse);
	}

function Search_Button_1() {                                 
	const SearchForm = document.getElementById('search_form_1');
	console.log('Search: ' + SearchForm.elements[0].value);  
	let text = '<b>Results:</b>';                                                            
	text += getFlagInfoFromID(Number(SearchForm.elements[0].value)) + '<br>';
	document.getElementById("search_form_result1").innerHTML = text;
	document.getElementById("button01").disabled = false;
	}

function GoToFlag_Button_1() {
	const SearchForm = document.getElementById('search_form_1');
	console.log('Go To Flag Id: ' + SearchForm.elements[0].value);
	Jump_to_Flag_from_ID(SearchForm.elements[0].value);
	}

function Search_Button_2() {                                 
	const SearchForm = document.getElementById('search_form_2');
	console.log('Search: ' + SearchForm.elements[0].value);
	let text = '<b>Results:</b>';                                                            
	text += getFlagInfoFromID(getFlagIDFromName(SearchForm.elements[0].value)) + '<br>';
	document.getElementById("search_form_result2").innerHTML = text;
	document.getElementById("button02").disabled = false;
	}

function GoToFlag_Button_2() {
	const SearchForm = document.getElementById('search_form_2');
	console.log('Go To Flag Name: ' + SearchForm.elements[0].value);
	Jump_to_Flag_from_ID(getFlagIDFromName(SearchForm.elements[0].value));
	}

function Jump_to_Flag_from_ID(value) {
	value = Number(value)
	for (const Flags_city of All_Flags_city) {
		const feature = Flags_city.features.find(f => f.id === value);
		if (feature) {
			const x = ( feature.geometry.coordinates[0][0][0] + ( ( feature.geometry.coordinates[0][2][0] - feature.geometry.coordinates[0][0][0] ) / 2 ));
			const y = ( feature.geometry.coordinates[0][0][1] + ( ( feature.geometry.coordinates[0][2][1] - feature.geometry.coordinates[0][0][1] ) / 2 ));
			const city = feature.properties.city
			City_data.forEach((value, index) => {
				eval('Layer0_City' + index).removeFrom(map)
				});
			eval('Layer0_City' + city).addTo(map)
			map.closePopup();
			map.removeLayer(SearchMarker);
			SearchMarker = new L.marker(xy([x, y])).on('click', function(e) { map.removeLayer(SearchMarker);});
			map.addLayer(SearchMarker);
			const PopupText = '<abbr style="white-space: nowrap;">Flag ID: ' + value + '</abbr>'
			SearchMarker.bindPopup(PopupText).openPopup();
			map.setView( xy([x, y]));
			console.log('Jumped to Flag Id: ' + value);
			return null;
			}
		}
	return null;
	}

function Search_Button_3() {
	const SearchForm = document.getElementById('search_form_3');
	console.log('Search: ' + SearchForm.elements[0].value);
	let text = '<b>Results:</b>'
	text += '<table style="white-space: nowrap;"><tr>'
	text += '<td>House:</td>'
	text += '<td>' + Account_data[Autocomplete_AccountName.indexOf(SearchForm.elements[0].value)][0] + '</td></tr>'
	text += '<tr><td>Current Descendant:</td>'
	text += '<td>' + Account_data[Autocomplete_AccountName.indexOf(SearchForm.elements[0].value)][1] + '</td></tr>'
	text += '<tr><td>Account ID:</td>'
	text += '<td>' + Autocomplete_AccountName.indexOf(SearchForm.elements[0].value) + '</td></tr>'
	text += '<tr><td colspan="2">Owned Flags:</td></tr>';
	text += getAllFlagsForID(Autocomplete_AccountName.indexOf(SearchForm.elements[0].value));
	text += '</table>'
	document.getElementById("search_form_result3").innerHTML = text;
	document.getElementById("button03").disabled = false;
	}

function Show_only_account_id_3() {
	Show_only_account_id = Autocomplete_AccountName.indexOf(document.getElementById('search_form_3').elements[0].value);
	resetStyleOfAll_Layer1_Flags_City();
	document.getElementById("Disable_Highlight_Button").style.display = "flex";
	document.getElementById("button03").disabled = true;
	}

function Search_Button_4() {
	const SearchForm = document.getElementById('search_form_4');
	console.log('Search: ' + SearchForm.elements[0].value);
	let text = '<b>Results:</b>'
	text += '<table style="white-space: nowrap;"><tr>'
	text += '<td>House:</td>'
	text += '<td>' + Account_data[Autocomplete_AccountHouse.indexOf(SearchForm.elements[0].value)][0] + '</td></tr>'
	text += '<tr><td>Current Descendant:</td>'
	text += '<td>' + Account_data[Autocomplete_AccountHouse.indexOf(SearchForm.elements[0].value)][1] + '</td></tr>'
	text += '<tr><td>Account ID:</td>'
	text += '<td>' + Autocomplete_AccountHouse.indexOf(SearchForm.elements[0].value) + '</td></tr>'
	text += '<tr><td colspan="2">Owned Flags:</td></tr>';
	text += getAllFlagsForID(Autocomplete_AccountHouse.indexOf(SearchForm.elements[0].value));
	text += '</table>'
	document.getElementById("search_form_result4").innerHTML = text;
	document.getElementById("button04").disabled = false;
	}

function Show_only_account_id_4() {
	Show_only_account_id = Autocomplete_AccountHouse.indexOf(document.getElementById('search_form_4').elements[0].value);
	resetStyleOfAll_Layer1_Flags_City();
	document.getElementById("Disable_Highlight_Button").style.display = "flex";
	document.getElementById("button04").disabled = true;
	}

function resetStyleOfAll_Layer1_Flags_City() {
	City_data.forEach((value, index) => {
		eval('Layer1_Flags_City' + index).resetStyle()
		});
	}

function getFlagIDFromName(FlagName) {
	for (const Flags_city of All_Flags_city) {
		const feature = Flags_city.features.find(f => f.properties.name === FlagName);
		if (feature) {
			console.log('Flag Name To ID: "' + FlagName + '" = ' + feature.id)
			return feature.id
			}
		}
	return null;
	}

function getFlagInfoFromID(FlagID) {
	for (const Flags_city of All_Flags_city) {
		const feature = Flags_city.features.find(f => f.id === FlagID);
		if (feature) {
			let html =''
			html += '<table style="white-space: nowrap;width: 100%;"><tr><td>Name:</td><td><b>'
			html += feature.properties.name
			html += '</b></td></tr><tr><td>Owner:</td><td>'
			html += Account_data[feature.properties.owner][1]
			html += '</b></td></tr><tr><td>House:</td><td>'
			html += Account_data[feature.properties.owner][0]
			html += '</b></td></tr><tr><td>City:</td><td>'
			html += City_data[feature.properties.city][0]
			html += '</td></tr><tr><td>Role:</td><td>'
			html += FLAG_ROLE_NAME[feature.properties.role]
			html += '</td></tr><tr><td>Active:</td><td>'
			html += feature.properties.active
			html += '</td></tr><tr><td>Flag ID:</td><td>'
			html += feature.id
			html += '</td></tr><tr><td>Size: </td><td>'
			html += `${Math.abs(feature.geometry.coordinates[0][0][0] - feature.geometry.coordinates[0][2][0]) + 1} x ${Math.abs(feature.geometry.coordinates[0][0][1] - feature.geometry.coordinates[0][2][1]) + 1}`
			html += '</td></tr><tr><td>Economic Power: </td><td>'
			html += feature.properties.ep
			html += ' %</td></tr><tr><td>Repair: </td><td>'
			html += feature.properties.repair
			html += ' %</td></tr></table>'
			return html;
			}
		}
	return null;
	}

function getAllFlagsForID(AccountID) {
	const breakAfter = 20;
	let cityResults = [];
	All_Flags_city.forEach((Flags_city, index) => {
		if (!Flags_city || !Flags_city.features) return;
		const filteredFeatures = Flags_city.features.filter(feature =>
			feature.properties.owner == AccountID
		);
		if (filteredFeatures.length === 0) return;
		const sortedIDs = filteredFeatures
			.map(feature => feature.id)
			.sort((a, b) => a - b);
		let formattedParts = [];
		for (let i = 0; i < sortedIDs.length; i += breakAfter) {
			const chunk = sortedIDs.slice(i, i + breakAfter);
			formattedParts.push(chunk.join(', '));
		}
		const formattedIDs = formattedParts.join('<br>');
		cityResults.push(`<tr><td colspan="2">&emsp;&emsp;&emsp;${City_data[index][0]}:</td></tr><tr><td></td><td>${formattedIDs}</td></tr>`);
		});
	if (cityResults.length === 0) {
		return null;
		}
	const finalResult = cityResults.join('');
	return finalResult;
	}

function generateLeaderboardTable(ArrayWithData, IndexInSubArray) {
	const entries = Object.entries(ArrayWithData).filter(([key, value]) => !isNaN(key) && Array.isArray(value));
	entries.sort((a,b) => b[1][IndexInSubArray] - a[1][IndexInSubArray]);
	let html = `<table class='popup_table'>`;
	html += `<thead><tr><th colspan="3"><h2>${Account_data_fieldNames[IndexInSubArray]} Leaderboard</h2></th></tr></thead><tbody>`;
	html += `<thead><tr><td><u><b>House</b></u></td><td><u><b>Name</b></u></td><td><u><b>${Account_data_fieldNames[IndexInSubArray]}</b></u></td></tr></thead><tbody>`;
	for (const [index, accountArray] of entries) {
		html += `<tr><td>${Account_data[index][0]}</td><td>${Account_data[index][1]}</td><td align="right">${formatNumberWithDots(accountArray[IndexInSubArray])}</td></tr>`;
		}
	html += `</tbody></table>`;
	return html;
	}

function formatNumberWithDots(NumberWithoutDots) {
	return NumberWithoutDots.toString().replace(/\B(?=(\d{3})+(?!\d))/g, ".");
	}

function function_select_first_marker(e) {
	L.DomEvent.addListener(map, 'click', this.function_select_first_marker_enterAddMarkerMode.bind(this));
	}

function function_select_first_marker_enterAddMarkerMode () {
	Select_Ignore_interactive_map_Rectangle.addTo(map);
	document.getElementById("InfluenceButton1").style.background="Lime";
	document.getElementById("InfluenceButton1").style.border="1px solid Green";
	document.getElementById("InfluenceButton1").disabled = true;
	document.getElementById("InfluenceButton2").disabled = true;
	document.getElementById("InfluenceButton3").disabled = true;
	this.map.addEventListener('click', this.function_select_first_marker_onMapClickAddMarker.bind(this));
	}

function function_select_first_marker_onMapClickAddMarker (e) {
	"use strict";
	Select_Ignore_interactive_map_Rectangle.remove();
	document.getElementById("InfluenceButton1").style.background="";
	document.getElementById("InfluenceButton1").style.border="";
	document.getElementById("InfluenceButton1").disabled = false;
	document.getElementById("InfluenceButton2").disabled = false;
	document.getElementById("InfluenceButton3").disabled = false;
	this.map.removeEventListener('click');
	SelectionMarkerFirst.remove();
	SelectionMarkerFirst = L.marker(e.latlng, {draggable: true});
	SelectionMarkerFirst.addTo(featureGroup_Legend);
	}

function function_select_second_marker(e) {
	L.DomEvent.addListener(map, 'click', this.function_select_second_marker_enterAddMarkerMode.bind(this));
	}

function function_select_second_marker_enterAddMarkerMode () {
	Select_Ignore_interactive_map_Rectangle.addTo(map);
	document.getElementById("InfluenceButton2").style.background="Lime";
	document.getElementById("InfluenceButton2").style.border="1px solid Green";
	document.getElementById("InfluenceButton1").disabled = true;
	document.getElementById("InfluenceButton2").disabled = true;
	document.getElementById("InfluenceButton3").disabled = true;
	this.map.addEventListener('click', this.function_select_second_marker_onMapClickAddMarker.bind(this));
	}

function function_select_second_marker_onMapClickAddMarker (e) {
	"use strict";
	Select_Ignore_interactive_map_Rectangle.remove();
	document.getElementById("InfluenceButton2").style.background="";
	document.getElementById("InfluenceButton2").style.border="";
	document.getElementById("InfluenceButton1").disabled = false;
	document.getElementById("InfluenceButton2").disabled = false;
	document.getElementById("InfluenceButton3").disabled = false;
	this.map.removeEventListener('click');
	SelectionMarkerSecond.remove();
	SelectionMarkerSecond = L.marker(e.latlng, {draggable: true});
	SelectionMarkerSecond.addTo(featureGroup_Legend);
	}

function function_get_selection_influence () {
	let Selection_x0 = 0
	let Selection_y0 = 0
	let Selection_x1 = 0 
	let Selection_y1 = 0
	let Selection_city = 0
	let Selection_is_empty = true
	let Influence_from_role_percent = [0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0]
	Selection_x0 = Math.min(SelectionMarkerFirst.getLatLng().lng, SelectionMarkerSecond.getLatLng().lng)// Longitude
	Selection_y0 = Math.min(SelectionMarkerFirst.getLatLng().lat, SelectionMarkerSecond.getLatLng().lat)// Latitude
	Selection_x1 = Math.max(SelectionMarkerFirst.getLatLng().lng, SelectionMarkerSecond.getLatLng().lng)// Longitude
	Selection_y1 = Math.max(SelectionMarkerFirst.getLatLng().lat, SelectionMarkerSecond.getLatLng().lat)// Latitude
	City_data.forEach((value, index) => {
		if (map.hasLayer(eval('Layer0_City' + index)) == true) { Selection_city = index }
		});
	const temp1 = SelectionMarkerFirst.getLatLng()
	const temp2 = SelectionMarkerSecond.getLatLng()
	featureGroup_Legend.clearLayers();
	SelectionMarkerFirst = L.marker(temp1, {draggable: true}).addTo(featureGroup_Legend);
	SelectionMarkerSecond = L.marker(temp2, {draggable: true}).addTo(featureGroup_Legend);
	rectangle_from_markers = L.rectangle([xy([Selection_x0, Selection_y0]),xy([Selection_x1, Selection_y1])], {color: 'Blue',fillColor: 'SkyBlue', weight: 3, fillOpacity: 0.9, interactive: false}).addTo(featureGroup_Legend);
	L.geoJson(All_Flags_city, {
		onEachFeature: function(feature, layer){
			let FlagIsAlreadyThere = 0
			let OtherFlag_x0 = feature.geometry.coordinates[0][0][0]
			let OtherFlag_y0 = feature.geometry.coordinates[0][0][1]
			let OtherFlag_x1 = feature.geometry.coordinates[0][2][0]
			let OtherFlag_y1 = feature.geometry.coordinates[0][2][1]
			if (
				   Selection_city == feature.properties.city
				&& Math.max(Selection_x0, OtherFlag_x0) < Selection_x1
				&& Math.max(Selection_y0, OtherFlag_y0) < Selection_y1
				&& Math.min(Selection_x1, OtherFlag_x1) > Selection_x0
				&& Math.min(Selection_y1, OtherFlag_y1) > Selection_y0
				) { Selection_is_empty = false }
			if ( Selection_city == feature.properties.city ) {
				const Selection_BlockSq = (Selection_x1 - Selection_x0) * (Selection_y1 - Selection_y0)
				OtherFlag_x0 -= feature.properties.inf
				OtherFlag_y0 -= feature.properties.inf
				OtherFlag_x1 += feature.properties.inf
				OtherFlag_y1 += feature.properties.inf
				if (
					   Math.max(Selection_x0, OtherFlag_x0) < Selection_x1
					&& Math.max(Selection_y0, OtherFlag_y0) < Selection_y1
					&& Math.min(Selection_x1, OtherFlag_x1) > Selection_x0
					&& Math.min(Selection_y1, OtherFlag_y1) > Selection_y0
					) {
						const BlocksOverSelection_x0 = Math.max(Selection_x0, OtherFlag_x0)
						const BlocksOverSelection_y0 = Math.max(Selection_y0, OtherFlag_y0)
						const BlocksOverSelection_x1 = Math.min(Selection_x1, OtherFlag_x1)
						const BlocksOverSelection_y1 = Math.min(Selection_y1, OtherFlag_y1)
						const InfluenceOverSelection_BlockSq = (BlocksOverSelection_x1 - BlocksOverSelection_x0) * (BlocksOverSelection_y1 - BlocksOverSelection_y0)
						Influence_from_role_percent[feature.properties.role] += ( InfluenceOverSelection_BlockSq / Selection_BlockSq * 100 ) // influence overlap in percent
						}
				}
			}
		})

	let SelectionSizeX = (Selection_x1 - Selection_x0)
	let SelectionSizeY = (Selection_y1 - Selection_y0)
	let WARNING = ""
	if (SelectionSizeX > 256){
		WARNING += "<h1 style='color: red; line-height: 0.4; white-space: nowrap;'>Selected x is larger than 256</h1>"
		}
	if (SelectionSizeY > 256){
		WARNING += "<h1 style='color: red; line-height: 0.4; white-space: nowrap;'>Selected y is larger than 256</h1>"
		}
	if (Selection_is_empty == false){
		WARNING += "<h1 style='color: red; line-height: 0.4; white-space: nowrap;'>Flag is already there</h1>"
		}
	InfluenceTable=`
		<table class='popup_table'><thead>${WARNING}</thead><tbody>
		<tr><td>Selection</td><td>${SelectionSizeX} x ${SelectionSizeY}</td></tr>
		<tr><td colspan="2"><b>Influence from role</b></td></tr>
		<tr><td>${FLAG_ROLE_NAME[1]}</td><td>${Math.trunc((Math.trunc(Influence_from_role_percent[1])+50)/100)}</td></tr>
		<tr><td>${FLAG_ROLE_NAME[2]}</td><td>${Math.trunc((Math.trunc(Influence_from_role_percent[2])+50)/100)}</td></tr>
		<tr><td>${FLAG_ROLE_NAME[3]}</td><td>${Math.trunc((Math.trunc(Influence_from_role_percent[3])+50)/100)}</td></tr>
		<tr><td>${FLAG_ROLE_NAME[4]}</td><td>${Math.trunc((Math.trunc(Influence_from_role_percent[4])+50)/100)}</td></tr>
		<tr><td>${FLAG_ROLE_NAME[5]}</td><td>${Math.trunc((Math.trunc(Influence_from_role_percent[5])+50)/100)}</td></tr>
		<tr><td>${FLAG_ROLE_NAME[6]}</td><td>${Math.trunc((Math.trunc(Influence_from_role_percent[6])+50)/100)}</td></tr>
		<tr><td>${FLAG_ROLE_NAME[7]}</td><td>${Math.trunc((Math.trunc(Influence_from_role_percent[7])+50)/100)}</td></tr>
		<tr><td>${FLAG_ROLE_NAME[8]}</td><td>${Math.trunc((Math.trunc(Influence_from_role_percent[8])+50)/100)}</td></tr>
		<tr><td>${FLAG_ROLE_NAME[9]}</td><td>${Math.trunc((Math.trunc(Influence_from_role_percent[9])+50)/100)}</td></tr>
		<tr><td>${FLAG_ROLE_NAME[10]}</td><td>${Math.trunc((Math.trunc(Influence_from_role_percent[10])+50)/100)}</td></tr>
		<tr><td>${FLAG_ROLE_NAME[11]}</td><td>${Math.trunc((Math.trunc(Influence_from_role_percent[11])+50)/100)}</td></tr>
		<tr><td>${FLAG_ROLE_NAME[12]}</td><td>${Math.trunc((Math.trunc(Influence_from_role_percent[12])+50)/100)}</td></tr>
		<tr><td>${FLAG_ROLE_NAME[13]}</td><td>${Math.trunc((Math.trunc(Influence_from_role_percent[13])+50)/100)}</td></tr>
		<tr><td>${FLAG_ROLE_NAME[14]}</td><td>${Math.trunc((Math.trunc(Influence_from_role_percent[14])+50)/100)}</td></tr>
		<tr><td>${FLAG_ROLE_NAME[15]}</td><td>${Math.trunc((Math.trunc(Influence_from_role_percent[15])+50)/100)}</td></tr>
		<tr><td>${FLAG_ROLE_NAME[16]}</td><td>${Math.trunc((Math.trunc(Influence_from_role_percent[16])+50)/100)}</td></tr>
		<tr><td>${FLAG_ROLE_NAME[17]}</td><td>${Math.trunc((Math.trunc(Influence_from_role_percent[17])+50)/100)}</td></tr>
		<tr><td colspan="3"><a target="_blank" href="https://townforge.net/manual/">townforge.net/manual/</a>  Influence</td></tr>
		</tbody>
		</table>
		`;
	var popup = L.popup({maxWidth: 1000, className: 'popup_without_tip', autoClose: true, closeOnClick: false})
			.setLatLng(xy([Selection_x1, (Selection_y1 + 60)]))
			.setContent(InfluenceTable)
			.openOn(featureGroup_Legend);
	}

function changeFontSizeForClass(CssClassName, TargetFontSize) {
	const elements = document.querySelectorAll(`.${CssClassName}`);
	elements.forEach(el => {
		el.style.fontSize = TargetFontSize;
		});
	}

function function_highlightFeature(e) {
		const layer = e.target;

		layer.setStyle({
			weight: 7,
			dashArray: '',
			fillOpacity: 0.8
			});
		layer.bringToFront();
		info.update(layer.feature);
		
		if (map.hasLayer(Layer0_Overlay_InfluenceMouseOver) == true) {
			if (layer.feature.properties.role != 0) {
				const influence = layer.feature.properties.inf
				const coordinates = [
					[
						xy((layer.feature.geometry.coordinates[0][0][0]) - influence,(layer.feature.geometry.coordinates[0][0][1]) - influence),
						xy((layer.feature.geometry.coordinates[0][1][0]) + influence,(layer.feature.geometry.coordinates[0][1][1]) - influence),
						xy((layer.feature.geometry.coordinates[0][2][0]) + influence,(layer.feature.geometry.coordinates[0][2][1]) + influence),
						xy((layer.feature.geometry.coordinates[0][3][0]) - influence,(layer.feature.geometry.coordinates[0][3][1]) + influence),
					],
					[xy(layer.feature.geometry.coordinates[0][0]),xy(layer.feature.geometry.coordinates[0][1]),xy(layer.feature.geometry.coordinates[0][2]),xy(layer.feature.geometry.coordinates[0][3])]
					]
				Influence_Rectangle_MouseOver = L.polygon( coordinates, {weight: 0, fillColor: 'LimeGreen', fillOpacity: 0.4, interactive: false}).addTo(Layer0_Overlay_InfluenceMouseOver);
				}
			}
	}	
	
function function_resetHighlight(e) {
		const layer = e.target;

		layer.setStyle({
			weight: 1,
			dashArray: '4',
			fillOpacity: 0.8
			});
		layer.bringToBack();
		info.update();

		if (map.hasLayer(Layer0_Overlay_InfluenceMouseOver) == true) {
			Influence_Rectangle_MouseOver.removeFrom(Layer0_Overlay_InfluenceMouseOver)
			}
	}

function onEachFeature(feature, layer) {	
		layer.on({	
			mouseover: function_highlightFeature,	
			mouseout: function_resetHighlight,	
			});
		const popup_text=(`
		<table class='popup_table'>
		<tr><td>Name:</td>				<td><b>${feature.properties.name}</b></td></tr>
		<tr><td>Owner:</td>				<td>${Account_data[feature.properties.owner][1]}</td></tr>
		<tr><td>House:</td>				<td>${Account_data[feature.properties.owner][0]}</td></tr>
		<tr><td>Role:</td>				<td>${FLAG_ROLE_NAME[feature.properties.role]}</td></tr>
		<tr><td>Active:</td>			<td>${feature.properties.active}</td></tr>
		<tr><td>Flag ID:</td>			<td>${feature.id}</td></tr>
		<tr><td>Size:</td>				<td>${Math.abs(feature.geometry.coordinates[0][0][0] - feature.geometry.coordinates[0][2][0]) + 1} x ${Math.abs(feature.geometry.coordinates[0][0][1] - feature.geometry.coordinates[0][2][1]) + 1}</td></tr>
		<tr><td>Economic Power:</td>	<td>${feature.properties.ep} %</td></tr>
		<tr><td>Repair:</td>			<td>${feature.properties.repair} %</td></tr>
		</table>
		`)
		layer.bindPopup(popup_text,{maxWidth: 1000,});
	}

function Style_Flags(feature) {
	return {
		weight: 1,
		opacity: 1,
		color: getColor_active(feature.properties.active),
		dashArray: '4',
		fillOpacity: 0.8,
		fillColor: getFillColorFlag(feature)
		};
	}

function getFillColorFlag(feature){
	let color = 'LightGray'
	if (Show_only_account_id == false) {
		if (map.hasLayer(LayerStyle_Role) == true) {
			color = getColor_role(feature.properties.role)
			}
		else if (map.hasLayer(LayerStyle_Repair) == true) {
			color = getColor_repair(feature.properties.repair)
			}
		else if (map.hasLayer(LayerStyle_Owner) == true) {
			color = getColor_owner(Account_data[feature.properties.owner][0])
			}
		else if (map.hasLayer(LayerStyle_EconomicPower) == true) {
			color = getColor_Economic_Power(feature.properties.ep)
			}
	}
	else if (Show_only_account_id == feature.properties.owner) {
		if (map.hasLayer(LayerStyle_Role) == true) {
			color = getColor_role(feature.properties.role)
			}
		else if (map.hasLayer(LayerStyle_Repair) == true) {
			color = getColor_repair(feature.properties.repair)
			}
		else if (map.hasLayer(LayerStyle_Owner) == true) {
			color = getColor_owner(Account_data[feature.properties.owner][0])
			}
		else if (map.hasLayer(LayerStyle_EconomicPower) == true) {
			color = getColor_Economic_Power(feature.properties.ep)
			}
	}
	return color
	}
function getColor_role(FlagRole) {
	return  FlagRoleColors[FlagRole]
	}

function getColor_active(FlagActive) {
	return  FlagActive == true  ? "Green"	:
			FlagActive == false ? "Red"		: "white" ;
	}
                        
function getColor_repair(FlagRepair) {
	return  FlagRepair > 70 ? "Chartreuse"		:
			FlagRepair > 60 ? "LightSalmon"		:
			FlagRepair > 50 ? "Coral"			:
			FlagRepair > 40 ? "Tomato"			:
			FlagRepair > 30 ? "OrangeRed"		:
			FlagRepair > 20 ? "MediumPurple" 	:
			FlagRepair >  0 ? "RebeccaPurple"	:
			FlagRepair == 0 ? "white"			: "white" ;
	}

function getColor_owner(AccountHouseName) {
	let sum = 0;
	for (let i = 0; i < AccountHouseName.length; i++) {
		sum += AccountHouseName.charCodeAt(i);
		}
	const r = (sum * 7) % 256; // change number in "sum * 7" to get different color, it must be prime number 
	const g = (sum * 41) % 256; // prime numbers: 2, 3, 5, 7, 11, 13, 17, 19, 23, 29, 31, 37, 41, 43, 47, 53, 59, 61, 67, 71, 73, 79, 83, 89, 97
	const b = (sum * 67) % 256;
	return `#${[r, g, b]
		.map((x) => x.toString(16).padStart(2, '0'))
		.join('')}`;
	}

function getColor_Economic_Power(FlagEconomicPower) {
	return  FlagEconomicPower == 300 ? "#0AF51A"	:
			FlagEconomicPower >  250 ? "#23AC1F"	:
			FlagEconomicPower >  200 ? "#22681B"	:
			FlagEconomicPower >  150 ? "#F58F0A"	:
			FlagEconomicPower >  100 ? "#AD6614"	:
			FlagEconomicPower == 100 ? "#694014"	: "white" ;
	}

function parseDate(StringWithGeneratedTime) {
	const [date, time] = StringWithGeneratedTime.split('_');
	const [year, month, day] = date.split('/').map(Number);
	const [hour, minute] = time.split(':').map(Number);
	return new Date(Date.UTC(year, month - 1, day, hour, minute));
	}
  
function update_tick_timer() {
	const now = new Date();
	let diff = Generated_time_edited - now;
	diff = Math.abs(diff);
	const totalSeconds = Math.floor(diff / 1000);
	const hours = Math.floor(totalSeconds / 3600);
	const minutes = Math.floor((totalSeconds % 3600) / 60);
	const seconds = totalSeconds % 60;
	TimerElement.textContent =`Last update ${hours}h ${minutes}m ${seconds}s ago`;
	}

function generateBaseMapsChooser() {
	City_data.forEach((value, index) => {
		baseMaps[value[0]] = eval('Layer0_City' + index)
		});
	}

function generateCityBoundsOrangeRectangles() {
	All_Flags_city.forEach(
		(Flags_cityN, index) => {
			let x0 = 0
			let y0 = 0
			let x1 = 0
			let y1 = 0
			Flags_cityN.features.forEach(
				feature => {
					x0 = Math.min(x0, feature.geometry.coordinates[0][0][0])
					y0 = Math.min(y0, feature.geometry.coordinates[0][0][1])
					x1 = Math.max(x1, feature.geometry.coordinates[0][2][0])
					y1 = Math.max(y1, feature.geometry.coordinates[0][2][1])
					}
				)
			x0 -= 1000
			y0 -= 1000
			x1 += 1000
			y1 += 1000
			L.rectangle([xy([x0, y0]),xy([x1, y1])], {color: "Orange",fill: false, weight: 10}).bindPopup("<abbr style='white-space: nowrap;'>No Flag is beyond this line<abbr>").addTo(eval(`Layer0_City` +  index))
			}
		)
	}

function generateMapBounds() {
	globalThis.MapBounds = []
	let x0 = 0
	let y0 = 0
	let x1 = 0
	let y1 = 0
	All_Flags_city.forEach(
		(Flags_cityN, index) => {
			Flags_cityN.features.forEach(
				feature => {
					x0 = Math.min(x0, feature.geometry.coordinates[0][0][0])
					y0 = Math.min(y0, feature.geometry.coordinates[0][0][1])
					x1 = Math.max(x1, feature.geometry.coordinates[0][2][0])
					y1 = Math.max(y1, feature.geometry.coordinates[0][2][1])
					}
				)
			}
		)
	const MaxBounds = Math.max(Math.abs(x0), Math.abs(y0), Math.abs(x1), Math.abs(y1)) + 5000
	MapBounds[0] = -MaxBounds
	MapBounds[1] = -MaxBounds
	MapBounds[2] = MaxBounds
	MapBounds[3] = MaxBounds
	}

function generateHtmlTableCitiesInfo() {
	let html = "<table class='popup_table'>"
	html += `<thead><tr><th colspan="8"><h2>Cities info</h2></th></tr></thead><tbody>`;
	html += `<tr><td>${City_data_fieldNames[0]}</td><td>${City_data_fieldNames[3]}</td><td>${City_data_fieldNames[1]}</td><td>${City_data_fieldNames[2]}</td><td>${City_data_fieldNames[4]}</td><td>${City_data_fieldNames[5]}</td><td>${City_data_fieldNames[6]}</td><td>${City_data_fieldNames[7]}</td></tr>`;
	html += `<tr><td colspan="8"></td></tr>`
	All_Flags_city.forEach(
		(Flags_cityN, index) => {
			html += `<tr><td>${City_data[index][0]}</td><td>${City_data[index][3]}</td><td>${City_data[index][1]}</td><td>${City_data[index][2]}</td><td>${City_data[index][4]}</td><td>${City_data[index][5]}</td><td>${City_data[index][6]}</td><td>${City_data[index][7]}</td></tr>`;
			}
		)
	html += `</tbody></table>`;
	return html
	}
	
</script>
<script>
const FLAG_ROLE_NAME = ["","agricultural","craft","industrial","commercial","basic residential","affluent residential","luxury residential","military","cultural","stonecutter","sawmill","kiln","smelter","workforce","road","research","fishery",]
const FlagRoleColors = ["white","LawnGreen","Cyan","SaddleBrown","Magenta","Orange","DarkOrange","OrangeRed","DarkSlateGray","MediumSlateBlue","Silver","ForestGreen","SandyBrown","Tan","NavajoWhite","DimGray","RebeccaPurple","RoyalBlue",]
const Img_role = []
	Img_role[0] = './dist/inactive.svg'
	Img_role[1] = './dist/farm.svg'
	Img_role[2] = './dist/anvil.svg'
	Img_role[3] = ''
	Img_role[4] = './dist/shop.svg'
	Img_role[5] = './dist/tent.svg'
	Img_role[6] = './dist/longhouse.svg'
	Img_role[7] = './dist/castle.svg'
	Img_role[8] = './dist/sword.svg'
	Img_role[9] = './dist/beer.svg'
	Img_role[10] = './dist/stone.svg'
	Img_role[11] = './dist/tree.svg'
	Img_role[13] = ''
	Img_role[14] = './dist/slave.svg'
	Img_role[15] = ''
	Img_role[16] = './dist/research.svg'
	Img_role[17] = './dist/ship.svg'

var map = L.map('map', {
	crs: L.CRS.Simple,
	minZoom: -5,
	maxZoom: 3,
	maxBoundsViscosity: 0.1,
	zoomControl: false, // i have it after attribution
	inertia: false,
	inertiaMaxSpeed: 1000,
	zoomAnimation: false,
	fadeAnimation: false,
	});
map.getRenderer(map).options.padding = 100; // How much to extend the clip area around the map view (relative to its size) e.g. 0.1 would be 10% of map view in each direction
map.on('zoomend', function () {
	if (map.hasLayer(Layer0_Overlay_TextFlagSize) == 1) {
		var zoomLevel = map.getZoom();
		console.log('Zoom: ' + zoomLevel)
		switch (zoomLevel) {
			case -5:
			case -4:
			case -3:
				changeFontSizeForClass('Flag_size', '0px');
				break;
			case -2:
				changeFontSizeForClass('Flag_size', '8px');
				break;
			case -1:
				changeFontSizeForClass('Flag_size', '10px');
				break;
			case 0:
			case 1:
			case 2:
				changeFontSizeForClass('Flag_size', '16px');
				break;
			case 3:
				changeFontSizeForClass('Flag_size', '18px');
				break;
			default:
				changeFontSizeForClass('Flag_size', '10px');
			}
		}
	});

let SearchMarker = L.marker()
const Select_Ignore_interactive_map_Rectangle = L.rectangle([[-10000000, -10000000],[10000000, 10000000]], {color: "gray", weight: 0, fillOpacity: 0, interactive: true});
let Influence_Rectangle_MouseOver
let Show_only_account_id = 0
let SelectionMarkerFirst = L.marker([0,0])
let SelectionMarkerSecond = L.marker([0,0])
let rectangle_from_markers

//<!-- Pulsing Marker -->
const cssIcon = L.divIcon({
	className: 'css-icon',
	html: '<div class="gps_ring"></div>'
	// Set marker width and height
	,iconSize: [22,22]
	// ,iconAnchor: [11,11]
	});
//<!-- Pulsing Marker -->

//<!-- xy to yx to L.latLng -->
const yx = L.latLng;
const xy = function(x, y) {
	if (Array.isArray(x)) {    // When doing xy([x, y]);
		return yx(x[1], x[0]);
		}
	return yx(y, x);  // When doing xy(x, y);
	};
//<!-- xy to yx to L.latLng -->

//<!--https://github.com/ablakey/Leaflet.SimpleGraticule --> 
const SimpleGraticuleOptions = {
	interval: 20,
	showOriginLabel: true,
	redraw: 'move',
	zoomIntervals: [
		{start: -5, end: -4, interval: 2048},
		{start: -3, end: -3, interval: 1024},
		{start: -2, end: -2, interval: 512 },
		{start: -1, end: -1, interval: 256 },
		{start:  0, end:  1, interval: 128 },
		{start:  2, end:  3, interval: 64  }
		]
	};
L.simpleGraticule(SimpleGraticuleOptions).addTo(map);
//<!-- https://github.com/ablakey/Leaflet.SimpleGraticule --> 
generateAll_Flags_city();
generateMapBounds();
map.setMaxBounds([[MapBounds[0],MapBounds[1]], [MapBounds[2],MapBounds[3]]]);
generateArray_Autocomplete_FlagId();
generateArray_Autocomplete_FlagName();
generateArray_Autocomplete_AccountHouse();
generateArray_Autocomplete_AccountName();
declareLayer0_City();
declareLayer0_Overlays();
declareLayer1_Image_InactiveFlags_City();
declareLayer1_Image_RoleFlags_City();
declareLayer1_TextFlagSize_City();
declareLayerStyle_Role();
declareLayerStyle_Repair();
declareLayerStyle_Owner();
declareLayerStyle_EconomicPower();
declareLayer1_Flags_City();
declareLayer1_Firefighting_City();
declareLayer1_TaxBreakPoints_City();
declareLayer0_City0_events();
declareLegend();
generate_RoleImg_InactiveImg_FlagSizeText_MilitaryFirefightingLayer();
generateTaxBreakPoints();
generateCityBoundsOrangeRectangles();

//<!-- Info panel top right -->>
const info = L.control();

info.onAdd = function (map) {
	this._div = L.DomUtil.create('div', 'info');
	this.update();
	return this._div;
	};

info.update = function (feature) {
	const contents = feature ? `
		<table>
		<tr><td align='right'><u>Flag ID</u></td></tr>
		<tr><td align='right'>${feature.id}</td></tr>
		<tr><td align='right'><u>Owner</u></td></tr>
		<tr><td align='right'>${Account_data[feature.properties.owner][1]}</td></tr>
		<tr><td align='right'><u>Flag Name</td></u></tr>
		<tr><td align='right'>${feature.properties.name}</td></tr>
		</table>
		` : 'Hover over a Flag';
	this._div.innerHTML = `<h4 align='right'>Flag Info</h4>${contents}`;
	};

info.addTo(map);
//<!-- Info panel top right -->>

text_bottom=`<a href="https://www.townforge.net/">Townforge</a> | <abbr title="${Generated_daemon_version} |  Generated at ${Generated_time_string} UTC / Blockchain height: ${Generated_blockchain_height} | Update should be each game tick"><abbr id="timer">Loading...</abbr></abbr>`
map.attributionControl.setPosition('bottomleft')
map.attributionControl.setPrefix(text_bottom)
const Generated_time_edited = parseDate(Generated_time_string);// attribution tick timer
const TimerElement = document.getElementById('timer');// attribution tick timer
update_tick_timer();// attribution tick timer
setInterval(update_tick_timer, 1000);// attribution tick timer
L.control.zoom({position:'bottomleft'}).addTo(map)

const legend_repair_text=`
								 <div class="Legend_text_background_repair" style="background-color:Chartreuse"		>> 70%</div>   
	<br class='Legend_br_height'><div class="Legend_text_background_repair" style="background-color:LightSalmon"	>> 60%</div>  
	<br class='Legend_br_height'><div class="Legend_text_background_repair" style="background-color:Coral"			>> 50%</div>        
	<br class='Legend_br_height'><div class="Legend_text_background_repair" style="background-color:Tomato"			>> 40%</div>       
	<br class='Legend_br_height'><div class="Legend_text_background_repair" style="background-color:OrangeRed"		>> 30%</div>    
	<br class='Legend_br_height'><div class="Legend_text_background_repair" style="background-color:MediumPurple"	>> 20%</div> 
	<br class='Legend_br_height'><div class="Legend_text_background_repair" style="background-color:RebeccaPurple"	>> 00%</div>
	<br class='Legend_br_height'><div class="Legend_text_background_repair" style="background-color:white"			>= 00%</div>        
	`                                                                                    
const legend_repair = L.control({position: 'bottomright'});                          
legend_repair.onAdd = function (map) {
	const div = L.DomUtil.create('div', 'info legend');
	
	div.innerHTML = legend_repair_text;
	return div;
	};

const legend_role_text=`                                                                             
								 <div class="Legend_text_background_role" style="background-color:${FlagRoleColors[0]} ">none                </div>
	<br class='Legend_br_height'><div class="Legend_text_background_role" style="background-color:${FlagRoleColors[1]} ">agricultural        </div>
	<br class='Legend_br_height'><div class="Legend_text_background_role" style="background-color:${FlagRoleColors[2]} ">craft               </div>
	<br class='Legend_br_height'><div class="Legend_text_background_role" style="background-color:${FlagRoleColors[3]} ">industrial          </div>
	<br class='Legend_br_height'><div class="Legend_text_background_role" style="background-color:${FlagRoleColors[4]} ">commercial          </div>
	<br class='Legend_br_height'><div class="Legend_text_background_role" style="background-color:${FlagRoleColors[5]} ">basic residential   </div>
	<br class='Legend_br_height'><div class="Legend_text_background_role" style="background-color:${FlagRoleColors[6]} ">affluent residential</div>
	<br class='Legend_br_height'><div class="Legend_text_background_role" style="background-color:${FlagRoleColors[7]} ">luxury residential  </div>
	<br class='Legend_br_height'><div class="Legend_text_background_role" style="background-color:${FlagRoleColors[8]} ">military            </div>
	<br class='Legend_br_height'><div class="Legend_text_background_role" style="background-color:${FlagRoleColors[9]} ">cultural            </div>
	<br class='Legend_br_height'><div class="Legend_text_background_role" style="background-color:${FlagRoleColors[10]}">stonecutter         </div>
	<br class='Legend_br_height'><div class="Legend_text_background_role" style="background-color:${FlagRoleColors[11]}">sawmill             </div>
	<br class='Legend_br_height'><div class="Legend_text_background_role" style="background-color:${FlagRoleColors[12]}">kiln                </div>
	<br class='Legend_br_height'><div class="Legend_text_background_role" style="background-color:${FlagRoleColors[13]}">smelter             </div>
	<br class='Legend_br_height'><div class="Legend_text_background_role" style="background-color:${FlagRoleColors[14]}">workforce           </div>
	<br class='Legend_br_height'><div class="Legend_text_background_role" style="background-color:${FlagRoleColors[15]}">road                </div>
	<br class='Legend_br_height'><div class="Legend_text_background_role" style="background-color:${FlagRoleColors[16]}">research            </div>
	<br class='Legend_br_height'><div class="Legend_text_background_role" style="background-color:${FlagRoleColors[17]}">fishery             </div>
	`
const legend_role = L.control({position: 'bottomright'});
legend_role.onAdd = function (map) {
	const div = L.DomUtil.create('div', 'info legend');
	div.innerHTML = legend_role_text;
	return div;
	};       
legend_role.addTo(map);
        
const legend_owner_text="Colors are generated from house name"
const legend_owner = L.control({position: 'bottomright'});
legend_owner.onAdd = function (map) {
	const div = L.DomUtil.create('div', 'info legend');
	div.innerHTML = legend_owner_text;
	return div;
	};

const legend_EcoPow_text=`
								 <div class="Legend_text_background_Economic_Power" style="background-color:#0AF51A">= 300%</div>
	<br class='Legend_br_height'><div class="Legend_text_background_Economic_Power" style="background-color:#23AC1F">> 250%</div>
	<br class='Legend_br_height'><div class="Legend_text_background_Economic_Power" style="background-color:#22681B">> 200%</div>
	<br class='Legend_br_height'><div class="Legend_text_background_Economic_Power" style="background-color:#F58F0A">> 150%</div>
	<br class='Legend_br_height'><div class="Legend_text_background_Economic_Power" style="background-color:#AD6614">> 100%</div>
	<br class='Legend_br_height'><div class="Legend_text_background_Economic_Power" style="background-color:#694014">= 100%</div>
	`
const legend_EcoPow = L.control({position: 'bottomright'});
legend_EcoPow.onAdd = function (map) {
	const div = L.DomUtil.create('div', 'info legend');
	div.innerHTML = legend_EcoPow_text;
	return div;
	};

const legend_Influence_calculator_text=`
	<b>Influence Calculator</b>
	<ol>
		<li><button id='InfluenceButton1' onclick='function_select_first_marker()'>Select first corner</button>
		<li><button id='InfluenceButton2' onclick='function_select_second_marker()'>Select second corner</button>
		<li><button id='InfluenceButton3' onclick='function_get_selection_influence()'>Calculate influence</button>
		</ol>
	`
const legend_Influence_calculator = L.control({position: 'bottomright'});
legend_Influence_calculator.onAdd = function (map) {
	const div = L.DomUtil.create('div', 'info legend');
	div.innerHTML = legend_Influence_calculator_text;
	return div;
	};

var baseMaps = new Object();
generateBaseMapsChooser()
var baseMaps_overlays = {
	'Firefighting range': Layer0_Overlay_Firefighting,
	'Tax break points': Layer0_Overlay_TaxBreakPoints,
	'Role images': Layer0_Overlay_RoleImages,
	'Flag influence': Layer0_Overlay_InfluenceMouseOver,
	'Flag size': Layer0_Overlay_TextFlagSize,
	};
var overlays = {
	'Role': LayerStyle_Role,
	'Repair': LayerStyle_Repair,
	'Owner': LayerStyle_Owner,
	'E.Power': LayerStyle_EconomicPower,
	};
var overlays_overlays = {};
var layerControl = L.control.layers(baseMaps,baseMaps_overlays,{ collapsed:false, position:'topleft' }).addTo(map);
var layerControl = L.control.layers(overlays,overlays_overlays,{ collapsed:false, position:'topleft' }).addTo(map);

const Burger_Search_popup = L.popup({maxWidth: 1000, className: 'popup_without_tip', autoClose: true, closeOnClick: false}).setLatLng(xy([0, 0]))
L.control.burgerMenu({
	title: "Search Menu",
	menuIcon: "<img src='./dist/search.svg' style='width:20px;'>" ,
	menuItems: [
		{title: "Search Flag ID", onClick: () => { 
			Burger_Search_popup.setContent(`
					<!--Make sure the form has the autocomplete function switched off:-->
					<form id='search_form_1' autocomplete='off' >
						<div class='autocomplete' style='min-width:300px;width:100%'>
							<b>Flag ID:</b>
							<input onclick='runAutocomplete_flag_id()' id='myInput1' type='text' placeholder='1'>
							</div></form>
					<button  onclick='Search_Button_1()'>Search</button>
					<p id='search_form_result1'></p>
					<button  onclick='GoToFlag_Button_1()' disabled='true' id='button01'>Go To Flag</button>
					`)
				.openOn(map);
			map.setView([0, 0]);
			}},
		{title: "Search Flag Name", onClick: () => { 
			Burger_Search_popup.setContent(`
					<!--Make sure the form has the autocomplete function switched off:-->
					<form id='search_form_2' autocomplete='off' >
						<div class='autocomplete' style='min-width:300px;width:100%'>
							<b>Flag name:</b>
							<input onclick='runAutocomplete_flag_names()' id='myInput2' type='text' placeholder='Helsengaard town square'>
							</div></form>
					<button  onclick='Search_Button_2()'>Search</button>
					<p id='search_form_result2'></p>
					<button  onclick='GoToFlag_Button_2()' disabled='true' id='button02'>Go To Flag</button>
					`)
				.openOn(map);
			map.setView([0, 0]);
			}},
		{title: "Search Name", onClick: () => { 
			Burger_Search_popup.setContent(`
					<!--Make sure the form has the autocomplete function switched off:-->
					<form id='search_form_3' autocomplete='off' >
						<div class='autocomplete' style='min-width:300px;width:100%'>
							<b>Descendant name:</b>
							<input onclick='runAutocomplete_account_names()' id='myInput3' type='text' placeholder='Sigrid Sigrúnarsdóttir'>
							</div></form>
					<button  onclick='Search_Button_3()'>Search</button>
					<p id='search_form_result3'></p>
					<button  onclick='Show_only_account_id_3()' disabled='true' id='button03'>Highlight these flags</button>
					`)
				.openOn(map);
			map.setView([0, 0]);
			}},
		{title: "Search House", onClick: () => { 
			Burger_Search_popup.setContent(`
					<!--Make sure the form has the autocomplete function switched off:-->
					<form id='search_form_4' autocomplete='off' >
						<div class='autocomplete' style='min-width:300px;width:100%'>
							<b>House name:</b>
							<input onclick='runAutocomplete_house_names()' id='myInput4' type='text' placeholder='Sigrún'>
							</div></form>
					<button  onclick='Search_Button_4()'>Search</button>
					<p id='search_form_result4'></p>
					<button  onclick='Show_only_account_id_4()' disabled='true' id='button04'>Highlight these flags</button>
					`)
				.openOn(map);
			map.setView([0, 0]);
			}},
		],
	}).addTo(map);

const Burger_Leaderboard_popup = L.popup({maxWidth: 1000, className: 'popup_without_tip', autoClose: true, closeOnClick: false}).setLatLng(xy([0, 0]))
const Burger_City_Info_popup = L.popup({maxWidth: 1000, className: 'popup_without_tip', autoClose: true, closeOnClick: false}).setLatLng(xy([0, 0]))
L.control.burgerMenu({
	title: "Info Menu",
	menuIcon: "<img src='./dist/info.svg' style='width:20px;'>" ,
	menuItems: [
		{title: "Cities info",onClick: () => {Burger_City_Info_popup.setContent(generateHtmlTableCitiesInfo()).openOn(map);},},
		{title: "Leaderboards",
			menuItems: [
				{title: "Gold",
				menuItems: [
					{title: Account_data_fieldNames[2],onClick: () => {Burger_Leaderboard_popup.setContent(generateLeaderboardTable(Account_data, 2)).openOn(map);},},
					{title: Account_data_fieldNames[6],onClick: () => {Burger_Leaderboard_popup.setContent(generateLeaderboardTable(Account_data, 6)).openOn(map);},},
					{title: Account_data_fieldNames[8],onClick: () => {Burger_Leaderboard_popup.setContent(generateLeaderboardTable(Account_data, 8)).openOn(map);},},
					{title: Account_data_fieldNames[19],onClick: () => {Burger_Leaderboard_popup.setContent(generateLeaderboardTable(Account_data, 19)).openOn(map);},},
					],},
				{title: "Food",
				menuItems: [
					{title: Account_data_fieldNames[7],onClick: () => {Burger_Leaderboard_popup.setContent(generateLeaderboardTable(Account_data, 7)).openOn(map);},},
					{title: Account_data_fieldNames[9],onClick: () => {Burger_Leaderboard_popup.setContent(generateLeaderboardTable(Account_data, 9)).openOn(map);},},
					{title: Account_data_fieldNames[20],onClick: () => {Burger_Leaderboard_popup.setContent(generateLeaderboardTable(Account_data, 20)).openOn(map);},},
					],},
				{title: "Food - Animals",
				menuItems: [
					{title: Account_data_fieldNames[3],onClick: () => {Burger_Leaderboard_popup.setContent(generateLeaderboardTable(Account_data, 3)).openOn(map);},},
					{title: Account_data_fieldNames[4],onClick: () => {Burger_Leaderboard_popup.setContent(generateLeaderboardTable(Account_data, 4)).openOn(map);},},
					{title: Account_data_fieldNames[5],onClick: () => {Burger_Leaderboard_popup.setContent(generateLeaderboardTable(Account_data, 5)).openOn(map);},},
					],},
				{title: "Other",
				menuItems: [
					{title: Account_data_fieldNames[10],onClick: () => {Burger_Leaderboard_popup.setContent(generateLeaderboardTable(Account_data, 10)).openOn(map);},},
					{title: Account_data_fieldNames[11],onClick: () => {Burger_Leaderboard_popup.setContent(generateLeaderboardTable(Account_data, 11)).openOn(map);},},
					{title: Account_data_fieldNames[12],onClick: () => {Burger_Leaderboard_popup.setContent(generateLeaderboardTable(Account_data, 12)).openOn(map);},},
					{title: Account_data_fieldNames[13],onClick: () => {Burger_Leaderboard_popup.setContent(generateLeaderboardTable(Account_data, 13)).openOn(map);},},
					{title: Account_data_fieldNames[14],onClick: () => {Burger_Leaderboard_popup.setContent(generateLeaderboardTable(Account_data, 14)).openOn(map);},},
					{title: Account_data_fieldNames[15],onClick: () => {Burger_Leaderboard_popup.setContent(generateLeaderboardTable(Account_data, 15)).openOn(map);},},
					{title: Account_data_fieldNames[16],onClick: () => {Burger_Leaderboard_popup.setContent(generateLeaderboardTable(Account_data, 16)).openOn(map);},},
					{title: Account_data_fieldNames[17],onClick: () => {Burger_Leaderboard_popup.setContent(generateLeaderboardTable(Account_data, 17)).openOn(map);},},
					{title: Account_data_fieldNames[18],onClick: () => {Burger_Leaderboard_popup.setContent(generateLeaderboardTable(Account_data, 18)).openOn(map);},},
					],},
				{title: "Sustained",
				menuItems: [
					{title: Account_data_fieldNames[21],onClick: () => {Burger_Leaderboard_popup.setContent(generateLeaderboardTable(Account_data, 21)).openOn(map);},},
					{title: Account_data_fieldNames[22],onClick: () => {Burger_Leaderboard_popup.setContent(generateLeaderboardTable(Account_data, 22)).openOn(map);},},
					{title: Account_data_fieldNames[23],onClick: () => {Burger_Leaderboard_popup.setContent(generateLeaderboardTable(Account_data, 23)).openOn(map);},},
					],},
				],
			},
		],
	}).addTo(map);
map.setView( [0, 0], -1)
</script>
</body>
</html>
